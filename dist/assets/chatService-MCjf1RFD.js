import{q as d,o as f,c,e as w,d as n,g as p,w as m,l as y,i as h,h as l,f as E,s as i,k as C}from"./index-BmE4jDWU.js";const x=async(r,s)=>{try{const t=s==="student"?"studentId":"professionalId",e=d(c(n,"chats"),m(t,"==",r),f("updatedAt","desc")),a=await p(e),o=[];return a.forEach(u=>{o.push({id:u.id,...u.data()})}),{success:!0,data:o}}catch(t){return console.error("Error al obtener chats del usuario:",t),{success:!1,message:"Error al obtener conversaciones",error:t.message}}},b=async r=>{try{const s=d(c(n,`chats/${r}/messages`),f("timestamp","asc")),t=await p(s),e=[];return t.forEach(a=>{e.push({id:a.id,...a.data()})}),{success:!0,data:e}}catch(s){return console.error("Error al obtener mensajes del chat:",s),{success:!1,message:"Error al obtener mensajes",error:s.message}}},R=(r,s)=>{const t=d(c(n,`chats/${r}/messages`),f("timestamp","asc"));return w(t,e=>{const a=[];e.forEach(o=>{a.push({id:o.id,...o.data()})}),s(a)},e=>{console.error("Error en suscripción a mensajes:",e),s([],e)})},j=async(r,s)=>{var t;try{const e=l(n,"chats",r),a=await h(e);if(!a.exists())throw new Error("El chat no existe");const o=await E(c(n,`chats/${r}/messages`),{...s,timestamp:i()});return await C(e,{lastMessage:s.text,updatedAt:i(),unreadCount:{...a.data().unreadCount,[s.from==="student"?"professional":"student"]:(((t=a.data().unreadCount)==null?void 0:t[s.from==="student"?"professional":"student"])||0)+1}}),{success:!0,message:"Mensaje enviado correctamente",data:{id:o.id,...s}}}catch(e){return console.error("Error al enviar mensaje:",e),{success:!1,message:"Error al enviar mensaje",error:e.message}}},v=async(r,s)=>{try{const t=d(c(n,"chats"),m("studentId","==",r),m("professionalId","==",s),y(1)),e=await p(t);if(!e.empty){const g=e.docs[0];return{success:!0,message:"Chat ya existente",data:{id:g.id,...g.data()}}}const a=await h(l(n,"users","students",r)),o=await h(l(n,"users","professionals",s));if(!a.exists()||!o.exists())throw new Error("Uno o ambos usuarios no existen");return{success:!0,message:"Chat creado correctamente",data:{id:(await E(c(n,"chats"),{studentId:r,professionalId:s,studentName:a.data().alias||`NRE: ${a.data().nre}`,professionalName:o.data().name,professionalRole:o.data().role,createdAt:i(),updatedAt:i(),lastMessage:"",unreadCount:{student:0,professional:0}})).id,studentId:r,professionalId:s,studentName:a.data().alias||`NRE: ${a.data().nre}`,professionalName:o.data().name,professionalRole:o.data().role}}}catch(t){return console.error("Error al crear chat:",t),{success:!1,message:"Error al crear conversación",error:t.message}}};export{j as a,b,v as c,x as g,R as s};
